@{
    ViewBag.Title = "Messages";
}

<h2>@ViewBag.Title</h2>

<div class="chat-container">
    <div id="messengerContainer" class="row">
        <div class="col-md-9">
            <div class="panel panel-info">
                <div class="panel-heading">
                    RECENT CHAT HISTORY
                </div>
                <div class="panel-body">
                    <ul class="media-list" id="messagesContainer">
                        
                    </ul>
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageToSend" placeholder="Enter Message">
                        <span class="input-group-btn">
                            <button class="btn btn-info" type="button" id="sendButton">SEND</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    ONLINE USERS
                </div>
                <div class="panel-body">
                    <ul class="media-list" id="usersContainer">
                       @* <li class="media">

                            <div class="media-body">

                                <div class="media">
                                    <a class="pull-left" href="#">
                                        <img class="media-object img-circle" style="max-height:40px;" src="">
                                    </a>
                                    <div class="media-body">
                                        <h5>Alex Deo | User </h5>

                                        <small class="text-muted">Active From 3 hours</small>
                                    </div>
                                </div>

                            </div>
                        </li>*@
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.1.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->

    <script>

        $(function () {
            window.currentUsernameName = '@User.Identity.Name';
            var chat = $.connection.chatHub,
                $messagesContainer = $('#messagesContainer'),
                $sendButton = $('#sendButton'),
                $messageToSend = $('#messageToSend');

            chat.client.addMessage = function (name, message, avatarUrl, date) {
                // Add the message to the page.
                $messagesContainer.append('<li class="media"><div class="media-body col-md-12"><div class="media"><a class="pull-left" href="#"><img class="media-object img-circle" width="60" height="60" src="' + avatarUrl + ' "></a><div class="media-body col-md-10">' + htmlEncode(message) + '<br><small class="text-muted">' + htmlEncode(name) + ' | ' + date + '</small><hr></div></div></div></li>');
            };

            $.connection.hub.start().done(function () {
                $sendButton.click(function () {
                    var name = window.currentUsernameName;
                    var message = $messageToSend.val();
                    $messageToSend.val("").focus();
                    console.log("hello");
                    chat.server.send(name, message);
                });
            });

            var entityMap = {
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': '&quot;',
                "'": '&#39;',
                "/": '&#x2F;'
            };

            function htmlEncode(string) {
                return String(string).replace(/[&<>"'\/]/g, function (s) {
                    return entityMap[s];
                });
            };
        });

    </script>
}